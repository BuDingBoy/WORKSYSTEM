<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="../css/workRecord.css" />
    <link rel="stylesheet" type="text/css" href="../css/common.css" />

    <link href="../css/bootstrap.css" type="text/css" rel="stylesheet">
    <script type="text/javascript" src="../js/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="../js/bootstrap.js"></script>
    <script type="text/javascript" src="../js/common.js"></script>
</head>
<body onload="searchWorkRecord()">
<header class="commonHeader">
    <div class="login-div">
        <nav  class="top-nav-connect" ><a href="WriteWorkRecord.html">写博文</a><a>写博文</a></nav>
    <img src="../images/monkey1.jpg" id="imgPhoto">
    <span class="loginIDStyle" id="loginNickname">一寸灰</span>
    </div>
</header>
<main class="mainClass">
<aside class="workAside"></aside>
<div class="workContent">
    <div >
        <form id="workRecordForm" >
            <div class="catalog" align="right">
                <input type="button" onclick="add()" value="新建"/>
                <input type="button" onclick="searchWorkRecord()" value="查询"/>
                <input type="button" onclick="modify()" value="修改"/>
                <input type="button" onclick="deleteWorkRecord()" value="删除"/>
            </div>
                <!--<table id="showWorkRecord" class="table table-hover">-->
                    <!--<thead>-->
                    <!--<tr>-->
                        <!--<th><input type="checkbox" id="allChecked" value="全选"/></th>-->
                        <!--<th hidden="true">记录编号</th>-->
                        <!--<th hidden="true">标题</th>-->
                        <!--<th>时间</th>-->
                        <!--<th>已完成</th>-->
                        <!--<th>未完成</th>-->
                        <!--<th>备注</th>-->
                    <!--</tr>-->
                    <!--</thead>-->
                    <!--<tbody>-->
                   <!---->
                    <!--</tbody>-->
                <!--</table>-->
        </form>
    </div>

</div>
    <div class="file-div">
        <div class="file-title">
            <span>附件</span>
        </div>

    </div>


    <!-- 模态框（Modal） -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="myModalLabel">
                        添加工作记录
                    </h6>
                    <button type="button" class="close" data-dismiss="modal"
                            aria-hidden="true">×
                    </button>
                </div>
                <div class="modal-body">
                   <form  class="modalForm">

                       <table id="modalWorkRecord">
                           <input type="hidden" name="operationType"/>
                           <input type="hidden" name="recordID"/>
                           <tbody>
                           <tr>
                               <th>已完成：</th>
                               <td> <textarea class="completedText" name="content"></textarea></td>
                           </tr>
                           <tr>
                               <th>未完成：</th>
                               <td>  <textarea class="completedText" name="noCompleted"></textarea></td>
                           </tr>
                           <tr>
                               <th> 备注：</th>
                               <td><textarea class="commentsText" name="title"></textarea></td>
                           </tr>
                           </tbody>
                       </table>
                   </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger"
                            data-dismiss="modal">取消
                    </button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="buttonOperation()" name="yes">
                        确定
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</main>
<footer>
</footer>

</body>
<script type="text/javascript">

    //设置连接的点击样式
    $(() =>{
        $('nav li:nth-of-type(1)').addClass('active');
        $.post('../staff/getLoginStaffVO.dao','',(results) =>{
            console.log(results.nickname);
            $('#loginNickname').text(results.nickname);

        },'json');
    });

    $('#allChecked').change(function(){
        $('#showWorkRecord input[type="checkbox"][name="workRecordCheck"]').prop('checked',$(this).is(':checked')?true:false);
    });
    function buttonOperation() {
        var operationType = $('#modalWorkRecord input[name="operationType"] ').val();
        // alert(operationType);
        if (operationType=='1'){
            addWorkRecord()
        }else if (operationType=='2'){
            modifyWorkRecord();
        }
    }
    function add() {
        $('#modalWorkRecord input[name="operationType"]').val("1");
        $('#modalWorkRecord textarea[name="content"]').val('');
        $('#modalWorkRecord textarea[name="noCompleted"]').val('');
        $('#modalWorkRecord textarea[name="title"]').val('');
        $('#myModal').modal('show');
    }
    function addWorkRecord() {

        var data={};
        data.content=$('#modalWorkRecord textarea[name="content"]').val();
        data.noCompleted=$('#modalWorkRecord textarea[name="noCompleted"]').val();
        data.title=$('#modalWorkRecord textarea[name="title"]').val();
        // console.log(data);
        // alert(data.title);
        $.post("../workRecord/insertWorkRecord.dao", data, function (results) {
           searchWorkRecord()

        }, "text");
    }
    
    function  searchWorkRecord() {
        var data={};
        $.post("../workRecord/findWorkRecordByWhere.dao",data,(results) =>{
            var str="";
            var tablestr="";
            $.each(results,(i,workRecordVO) =>{
                var comp=workRecordVO.content;
                if (comp.length>150){
                    comp=comp.slice(0,150)+'...';
                }
               str +=`
            <div class="a-workRecord-div" onmouseout="overShow(this)" onmouseover="openLink(this)">
                <input type="hidden" name="recordID" value="${workRecordVO.recordID}">
                <input type="hidden" name="staffID" value="${workRecordVO.staffID}">
                <h4 class="a-workRecord-title-h" >${workRecordVO.title}</h4>
                <p class="a-workRecord-context-p">${comp}</p>
                <div class="a-workRecord-dis">
                    <span>${workRecordVO.recordDate}</span>
                    <div>
                        <nav >
                            <a href="WriteWorkRecord.html">编辑</a>|
                            <a>删除</a>
                        </nav>
                    </div>
                </div>
            </div>
            `;

                // tablestr +=`
                //   <tr>
                //
                //     <td><input type="checkbox" name="workRecordCheck" /></td>
                //     <td name="recordID" hidden="true">${workRecordVO.recordID}</td>
                //      <td name="staffID" hidden="true">${workRecordVO.staffID}</td>
                //      <td name="recordDate">${workRecordVO.recordDate}</td>
                //       <td name="content">${comp}</td>
                //        <td name="noCompleted">${workRecordVO.noCompleted}</td>
                //         <td name="title">${workRecordVO.title}</td>
                // </tr>
                // `;
            });
            $("#workRecordForm").append(str);
            // $("#showWorkRecord tbody").html(tablestr);
        },"json");
    }

    /**
     * 鼠标移动到上面时显示右下角操作连接
     */
    function openLink(x) {
        console.log( $(x).find("nav").text())
        $(x).find("nav").css("display","inline");
    }
    function overShow(x) {
        $(x).find("nav").css("display","none");
    }
    function modify() {
        let $compnent = $('#showWorkRecord input[name="workRecordCheck"]:checked').parent('td').parent('tr');
       if ($compnent.length<1){
           alert('请选择一条数据！')
       } else if ($compnent.length>1){
            alert('只能选择一条数据！')
        } else{
           $('#modalWorkRecord input[name="operationType"]').val("2");
           $('#modalWorkRecord input[name="recordID"]').val($compnent.eq(0).children('td[name="recordID"]').text());
           $('#modalWorkRecord textarea[name="content"]').val($compnent.eq(0).children('td[name="content"]').text());
           $('#modalWorkRecord textarea[name="noCompleted"]').val($compnent.eq(0).children('td[name="noCompleted"]').text());
           $('#modalWorkRecord textarea[name="title"]').val($compnent.eq(0).children('td[name="title"]').text());
            $('#myModal').modal('show');
           searchWorkRecord();
        }
    }
    function modifyWorkRecord() {
        var data={};
        data.recordID=$('#modalWorkRecord input[name="recordID"]').val();
        data.content=$('#modalWorkRecord textarea[name="content"]').val();
        data.noCompleted=$('#modalWorkRecord textarea[name="noCompleted"]').val();
        data.title=$('#modalWorkRecord textarea[name="title"]').val();
        // console.log(data);
        // alert(data.recordID);
        $.post("../workRecord/updateWorkRecordByKey.dao", data, function (results) {
            // console.log(results);

            searchWorkRecord();

        }, "text");
    }
    function  deleteWorkRecord() {
        let $compnent =$('#showWorkRecord input[name="workRecordCheck"]:checked').parent('td').parent('tr');
        var recordID='';
        for (var i=0;i<$compnent.length;i++){
            if (i==0){
                recordID=$compnent.eq(i).children('td[name="recordID"]').text();
            }else{
                recordID +=','+$compnent.eq(i).children('td[name="recordID"]').text();
                console.log(recordID);
            }
        }
        alert(recordID);
        let data={};
        data.recordID=recordID;
        $.post("../workRecord/deleteWorkRecordByKey.dao",data,(results) =>{
            if (results=='1'){
                searchWorkRecord();
            } else {
                alert('删除失败！');
            }
        },'text');
    }
</script>
</html>